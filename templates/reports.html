{% extends "base.html" %}
{% block content %}
<div class="container py-5">

    <!-- Page Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold">Reports & Analytics</h2>
        <p class="text-muted fs-6">
            Filter and analyze evaluation results by student, date, version, or flagged status. Select a subject to view
            its score distribution graph.
        </p>
    </div>

    <!-- Filter Form -->
    <div class="card shadow-sm mb-4 p-4">
        <h5 class="fw-semibold mb-3">Filter Reports</h5>
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Student ID</label>
                <input type="text" name="student_id" class="form-control" placeholder="e.g. S12345"
                    value="{{ filters.student_id }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date</label>
                <input type="text" name="date" class="form-control" placeholder="YYYY-MM-DD" value="{{ filters.date }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Version</label>
                <select name="version" class="form-select">
                    <option value="">All Versions</option>
                    {% for v in versions %}
                    <option value="{{ v }}" {% if filters.version==v %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Flagged?</label>
                <select name="flagged" class="form-select">
                    <option value="">Any</option>
                    <option value="1" {% if filters.flagged=='1' %}selected{% endif %}>Yes</option>
                    <option value="0" {% if filters.flagged=='0' %}selected{% endif %}>No</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
            <div class="col-md-2 d-flex gap-2">
                <a href="?export=csv" class="btn btn-outline-secondary w-100">Export CSV</a>
                <a href="?export=excel" class="btn btn-outline-secondary w-100">Export Excel</a>
            </div>
        </form>
    </div>

    <!-- Reports Table -->
    <div class="card shadow-sm mb-5 p-4">
        <h5 class="fw-semibold mb-3">Evaluation Reports</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Student ID</th>
                        <th>Date</th>
                        <th>OMR Sheet</th>
                        <th>Answer Key</th>
                        <th>Version</th>
                        {% for subject in subjects %}
                        <th>{{ subject }}</th>
                        {% endfor %}
                        <th>Total Score</th>
                        <th>Total Questions</th>
                        <th>Flagged</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reports %}
                    {% for r in reports %}
                    <tr>
                        <td>{{ r.get('Student ID', '-') }}</td>
                        <td>{{ r.get('Date', '-') }}</td>
                        <td>{{ r.get('OMR Sheet', '-') }}</td>
                        <td>{{ r.get('Answer KEY', '-') }}</td>
                        <td>{{ r.get('Version', '-') }}</td>
                        {% for subject in subjects %}
                        <td>{{ r.get(subject, 0) }}</td>
                        {% endfor %}
                        <td>{{ r.get('Total Score', 0) }}</td>
                        <td>{{ r.get('Total Questions', 0) }}</td>
                        <td>
                            {% if r.get('Flagged', False) %}
                            <span class="badge bg-warning text-dark">Flagged</span>
                            {% else %}-{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="{{ 5 + subjects|length }}">No reports found.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Subject-wise Chart -->
    <div class="card shadow-sm p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-semibold">Subject-wise Score Distribution</h5>
            <select id="subjectSelect" class="form-select w-auto">
                {% for subject in subjects %}
                <option value="{{ subject }}">{{ subject }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="chart-container" style="position: relative; height:300px;">
            <canvas id="subjectChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const subjects = {{ subjects| tojson }};
    const reports = {{ reports| tojson }};
    const subjectSelect = document.getElementById('subjectSelect');
    const ctx = document.getElementById('subjectChart').getContext('2d');
    let chart;

    function getBins(scores) {
        let bins = { "0-5": 0, "6-10": 0, "11-15": 0, "16-20": 0 };
        scores.forEach(s => {
            if (s <= 5) bins["0-5"]++;
            else if (s <= 10) bins["6-10"]++;
            else if (s <= 15) bins["11-15"]++;
            else bins["16-20"]++;
        });
        return bins;
    }

    function updateChart(subject) {
        const scores = reports.map(r => r[subject] || 0);
        const bins = getBins(scores);
        const data = {
            labels: Object.keys(bins),
            datasets: [{
                label: subject + " Scores",
                data: Object.values(bins),
                backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
        };
        const options = { responsive: true, scales: { y: { beginAtZero: true } } };
        if (chart) chart.destroy();
        chart = new Chart(ctx, { type: 'bar', data, options });
    }

    subjectSelect.addEventListener('change', (e) => {
        updateChart(e.target.value);
    });

    // Initialize chart with first subject
    updateChart(subjects[0]);
</script>
{% endblock %}